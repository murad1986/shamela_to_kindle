Техническая документация (shamela_to_kindle)

Этот документ описывает архитектуру библиотеки `shamela_books` (src‑layout), минимальные и профильные ограничения EPUB3 для Kindle/Apple, логику оглавления/сносок/картинок и логику формирования обложки. Исторически логика начиналась в `scripts/shamela_to_epub.py`, теперь она разложена по модулям.

1) Минимальный профиль EPUB3 (Kindle‑friendly)
- Главы: простые XHTML с `dir="rtl"`, внешний CSS, без inline‑стилей.
- Навигация: `nav.xhtml` присутствует в манифесте, но НЕ добавляется в `spine`.
- Шрифты: не встраиваются.
- Обложка: при наличии добавляется как `properties="cover-image"` (EPUB3) + `meta name="cover"` (EPUB2‑совместимый хинт для Kindle). Без отдельной страницы обложки.
- Метаданные: `dc:title` и `dc:creator` очищаются и берутся из блока «بطاقة الكتاب».
- Сноски: глобальная нумерация по всей книге; ссылки в тексте ведут на `text/endnotes.xhtml#note-<G>`, где `<G>` — глобальный идентификатор. В конце формируется `endnotes.xhtml` c `<ol>` (нумерация рендерится ридером); явный префикс номера в `<li>` не добавляется, чтобы избежать дублирования (`G.G`) на Kindle. Обратные ссылки ведут на конкретный файл главы `<chapter>.xhtml#ref-<G>`.

Профили:
- `minimal` — как описано выше; 
- `kindle` — эквивалентно minimal с консервативной очисткой;
- `apple` — более строгий санитайзер (ограниченный набор тегов), явный `xmlns:epub` в XHTML.

2) Логика сборки (высокоуровнево)
- Парсинг оглавления: со страницы книги `.../book/<id>` извлекаются ссылки на главы `/book/<id>/<num>`; порядок — DOM‑порядок.
- Скачивание глав: последовательные запросы с троттлингом (настройка `--throttle`).
- Извлечение текста: приоритетно `div.nass`, без скриптов/навигации; разрешён ограниченный набор тегов (заголовки, списки, цитаты, таблицы, `pre/code`, `img`, `figure/figcaption`).
- Имя файла: `<Название> - <Издатель>.epub` (удаляется префикс «كتاب/الكتاب», пробелы сохраняются, недопустимые символы удаляются).

Оглавление:
- Базовый TOC формируется по ссылкам `/book/<id>/<num>` (порядок — DOM).
- Дополнительный вложенный TOC строится по заголовкам `h2/h3` в теле глав; заголовки получают стабильные `id` `sec-<chapterId>-<n>` и попадают в `nav.xhtml` как вложенные элементы.

Изображения:
- Внешние `<img src=...>` скачиваются, фильтруются по MIME (JPEG/PNG), минимальному размеру/байтам, сохраняются в `OEBPS/images/imgNNNN.(jpg|png)` и ссылки переписываются.
- Поведение настраивается через API (`images_min_size`, `images_min_bytes`).

3) Обложка книги: логика формирования
- Опции:
  - `--cover-auto` — автопоиск обложки через Google Images.
  - `--cover path/to.(jpg|png)` — вручную заданный файл обложки.
- Поисковые запросы (`--cover-auto`):
  - `"<Название> cover"`, `"<Название> book cover"`, `"<Название> غلاف"`.
- Извлечение кандидатов:
  - Разбор HTML Google Images (без JS): поля вида `"ou":"<url>"` и fallback на прямые ссылки `*.jpg|jpeg|png`.
  - Фильтры на домены/мусор: исключаются `gstatic`/`google`/`logo`.
- Валидация изображений:
  - MIME: только `image/jpeg` или `image/png`.
  - Размер: минимальная сторона ≥ 300 px (PNG/JPEG), размер файла ≥ 50 KB.
  - Аспект‑ratio: по умолчанию в пределах `0.5..2.2`.
  - Берётся первый кандидат, удовлетворяющий фильтрам (до 8 на запрос).
- Встраивание в EPUB:
  - Файл помещается в `OEBPS/images/cover.(jpg|png)`.
  - Манифест: `<item id="cover-image" ... properties="cover-image"/>`.
  - Метаданные: добавляется `<meta name="cover" content="cover-image"/>` для совместимости с Kindle.
- Отказоустойчивость: при отсутствии подходящих кандидатов сборка продолжается без обложки (лог‑предупреждение).

4) Известные ограничения
- Google Images периодически меняет разметку; парсер использует несколько fallback‑паттернов.
- Некоторые «обложки» — иконки/логотипы; фильтры по MIME/размеру/аспекту отсекают большую часть мусора, но не гарантируют 100% релевантности.
- Приоритет — стабильность Send‑to‑Kindle: отсутствие обложки предпочтительнее, чем проблемная обложка.

5) Параметры CLI (сводка)
- `--throttle <sec>` — задержка между запросами (по умолчанию 0.8).
- `--limit <N>` — первые N глав (для быстрых тестов).
- `--cover-auto` — автопоиск обложки.
- `--cover <path>` — локальная обложка (JPEG/PNG, ≥ 300×300).

5) Кэш и провайдеры
- Кэш: файловый `.cache/shamela_books/` (переменная `SHAMELA_CACHE_DIR`), кэшируются HTML и изображения/обложки; можно отключить `--no-cache` (CLI) или `use_cache=False` (API).
- Провайдеры: `Provider` протокол (`fetch_index`, `fetch_chapter`), реализация `ShamelaProvider` по умолчанию; можно внедрять альтернативные источники.

6) Реализация сносок (детали)
- Извлечение: из завершающего блока `<p class="hamesh">` по шаблонам `(N) ...` и `N. / N- / N:` (поддерживаются арабские и латинские цифры).
- Привязка в тексте: нормализуются существующие `<sup><a>...</a></sup>`, а также «голые» `<sup>...</sup>` и маркеры `(N)`; отображаемое число заменяется на глобальный `<G>`.
- Нумерация: G присваивается после скачивания всех глав, последовательно в порядке оглавления и появления в главе.
- Очистка текста сносок: удаляются ведущие числовые токены (арабские/персидские/латинские) с типичной пунктуацией и скобками; также очищаются bidi‑символы/неразрывные пробелы, чтобы избежать «G.G …».
 - Несколько блоков `hamesh`: поддерживаются; сноски дедуплицируются по номеру (берётся первый текст).
 - Привязка к разделам: на странице «الهوامش» рядом с ↩︎ добавляется ссылка на ближайший заголовок `h2/h3` («— Название раздела»).
