Техническая документация (shamela_to_kindle)

Этот документ описывает архитектуру скрипта `scripts/shamela_to_epub.py`, минимальный профиль EPUB3 для Kindle и логику формирования обложки.

1) Минимальный профиль EPUB3 (Kindle‑friendly)
- Главы: простые XHTML с `dir="rtl"`, внешний CSS, без inline‑стилей.
- Навигация: `nav.xhtml` присутствует в манифесте, но НЕ добавляется в `spine`.
- Шрифты: не встраиваются.
- Обложка: при наличии добавляется как `properties="cover-image"` (EPUB3) + `meta name="cover"` (EPUB2‑совместимый хинт для Kindle). Без отдельной страницы обложки.
- Метаданные: `dc:title` и `dc:creator` очищаются и берутся из блока «بطاقة الكتاب».

2) Логика сборки (высокоуровнево)
- Парсинг оглавления: со страницы книги `.../book/<id>` извлекаются ссылки на главы `/book/<id>/<num>`; порядок — DOM‑порядок.
- Скачивание глав: последовательные запросы с троттлингом (настройка `--throttle`).
- Извлечение текста: приоритетно `div.nass`, без скриптов/навигации.
- Имя файла: `<Название> - <Издатель>.epub` (удаляется префикс «كتاب/الكتاب», пробелы сохраняются, недопустимые символы удаляются).

3) Обложка книги: логика формирования
- Опции:
  - `--cover-auto` — автопоиск обложки через Google Images.
  - `--cover path/to.(jpg|png)` — вручную заданный файл обложки.
- Поисковые запросы (`--cover-auto`):
  - `"<Название> cover"`, `"<Название> book cover"`, `"<Название> غلاف"`.
- Извлечение кандидатов:
  - Разбор HTML Google Images (без JS): поля вида `"ou":"<url>"` и fallback на прямые ссылки `*.jpg|jpeg|png`.
  - Фильтры на домены/мусор: исключаются `gstatic`/`google`/`logo`.
- Валидация изображений:
  - MIME: только `image/jpeg` или `image/png`.
  - Размер: минимальная сторона ≥ 300 px (PNG/JPEG), размер файла ≥ 50 KB.
  - Берётся первый кандидат, удовлетворяющий фильтрам (до 8 на запрос).
- Встраивание в EPUB:
  - Файл помещается в `OEBPS/images/cover.(jpg|png)`.
  - Манифест: `<item id="cover-image" ... properties="cover-image"/>`.
  - Метаданные: добавляется `<meta name="cover" content="cover-image"/>` для совместимости с Kindle.
- Отказоустойчивость: при отсутствии подходящих кандидатов сборка продолжается без обложки (лог‑предупреждение).

4) Известные ограничения
- Google Images периодически меняет разметку; парсер использует несколько fallback‑паттернов.
- Некоторые «обложки» — иконки/логотипы; фильтры по MIME/размеру отсекают большую часть мусора, но не гарантируют 100% релевантности.
- Приоритет — стабильность Send‑to‑Kindle: отсутствие обложки предпочтительнее, чем проблемная обложка.

5) Параметры CLI (сводка)
- `--throttle <sec>` — задержка между запросами (по умолчанию 0.8).
- `--limit <N>` — первые N глав (для быстрых тестов).
- `--cover-auto` — автопоиск обложки.
- `--cover <path>` — локальная обложка (JPEG/PNG, ≥ 300×300).

