shamela_books — парсер книг и сборщик EPUB (RTL)

[English](README.en.md) | [العربية](README.ar.md) | Русский

Проект для выгрузки книг с сайта `shamela.ws` и сборки из них файлов EPUB с корректной поддержкой арабского письма (RTL) и удобной навигацией.

## TL;DR
 - Базово (с автопоиском обложки): `python -m shamela_books 'https://shamela.ws/book/158' --throttle 0.6`
 - Отключить автопоиск обложки: исключите `--cover-auto` (по умолчанию авто включён)
 - Свой файл обложки: `--cover path/to.jpg|png`
- Результат: `output/<Название книги> - <Издатель>.epub`

## Установка (опционально)
- Локально: `pip install -e .`
- Через pipx: `pipx install .`
- Запуск CLI: `shamela-to-epub 'https://shamela.ws/book/158' --throttle 0.6`

## Структура
- `src/shamela_books/` — библиотека (парсеры, сборщик EPUB, CLI).
- `scripts/` — совместимость/обёртки (устаревает).
- `output/` — готовые файлы (EPUB).

## Быстрый старт
- Python 3.11+: `python -m shamela_books 'https://shamela.ws/book/158' --throttle 0.6`
- Через CLI: `shamela-to-epub 'https://shamela.ws/book/158' --throttle 0.6`
- С обложкой: `--cover-auto` или `--cover path/to.jpg|png`
- Результат: `output/<Название книги> - <Издатель>.epub`.

## Использование как модуль
```python
from shamela_books import build_epub_from_url

out = build_epub_from_url(
    'https://shamela.ws/book/158',
    throttle=0.8,
    cover_auto=True,
    cover_query='...',
    cover_min_size=(600, 800),
)
print('EPUB at', out)
```

## Поддерживаемый формат (один, «рабочий»)
- EPUB (минимальный профиль, оптимален для Send‑to‑Kindle):
  - Без обложки и страницы «بطاقة الكتاب».
  - Без встроенных шрифтов.
  - `nav.xhtml` присутствует в манифесте, но не включён в `spine`.
  - Сноски: глобальная нумерация по всей книге; ссылки в тексте → `endnotes.xhtml#note-<G>`; в конце ↩︎ ведёт обратно в исходную главу `#ref-<G>`. Для Kindle исключено дублирование номера (номер списка `<ol>` используется как основной; явный префикс в тексте элемента не добавляется).

## Ключевые опции
- `-o, --output` — путь к выходному файлу (по умолчанию берётся из названия книги + издатель).
- `--throttle 0.6` — пауза между запросами (сек).
- `--limit N` — ограничить число глав (для тестов).
 - `--cover-auto` — автопоиск обложки (включён по умолчанию). Если не удалось — файл собирается без обложки.
 - `--cover path/to.jpg|png` — задать локальную обложку вручную (рекомендуется ≥ 300×300).

### Сводная таблица опций

| Опция | Описание | По умолчанию | Пример |
|---|---|---|---|
| `-o, --output <path>` | Путь к выходному файлу | `output/<Название> - <Издатель>.epub` | `-o output/book.epub` |
| `--throttle <sec>` | Пауза между HTTP‑запросами | `0.8` | `--throttle 0.6` |
| `--limit <N>` | Скачивать только первые N глав (для теста) | все главы | `--limit 10` |
| `--cover-auto` | Автопоиск обложки (Google Images + фильтры размера/типа) | выкл | `--cover-auto` |
| `--cover <file>` | Локальная обложка (JPEG/PNG, ≥ 300×300) | отсутствует | `--cover cover.jpg` |

## Обложка и «بطاقة الكتاب»
- По умолчанию обложка не добавляется (для максимальной совместимости). При необходимости:
  - `--cover-auto` — автопоиск обложки (Google Images). Логика и фильтры описаны в TECHNICAL.md.
  - `--cover path/to.jpg|png` — вручную задать файл обложки (рекомендуется ≥ 300×300).

## Сноски (الهوامش)
- В тексте: отображаются глобальные номера `1..N` (латинские цифры), кликабельные на конец книги.
- В конце: сформирован `endnotes.xhtml` со списком `<ol>`; удаляются повторные ведущие числа из исходного текста.
- Обратная ссылка ↩︎ возвращает к месту в конкретной главе.

## Что не работало и что работает
- Работает стабильно: минимальный EPUB — без шрифтов, без обложки/«بطاقة الكتاب», `nav.xhtml` не в `spine`.
- Не работало (через Send‑to‑Kindle для этой книги):
  - EPUB с обложкой/«بطاقة الكتاب» и/или встроенными шрифтами — ошибка e999.
  - Старые профили (с NCX/сложными метаданными) — нестабильно.

Подробнее о профиле и обложке: см. TECHNICAL.md.

## Пример
- `python -m shamela_books 'https://shamela.ws/book/158' --throttle 0.6`
