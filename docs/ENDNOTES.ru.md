# Сноски: дизайн и реализация

Цель — кликабельные сноски, работающие одинаково на Kindle и Apple Books, без дублирования номеров.

## Правила нумерации

- Глобальная нумерация по книге: `G = 1..N` назначается после скачивания всех глав в порядке оглавления и появления ссылок.
- В тексте глав отображаются именно глобальные номера `G` (латинские цифры), независимо от исходных `(١)`/`(N)` в источнике.

## Извлечение

- Источник: завершающий блок `<p class="hamesh">` с разметкой:
  - `(N) текст` или `N. / N- / N: текст` (поддерживаются арабские/персидские/латинские цифры).
- Очистка: удаляются bidi‑символы, неразрывные пробелы; текст приводится к безопасной строке.

## Привязка ссылок

- В тексте заменяются:
  - `(N)` → `<sup><a id="ref-G" href="endnotes.xhtml#note-G">G</a></sup>`;
  - `<sup>١</sup>` / `<sup>(١)</sup>` → нормализованные ссылки на глобальный `G`;
  - `<sup><a>…</a></sup>` из источника переписываются на глобальные `G`.
- В конце формируется `endnotes.xhtml` с `<ol>`; явный префикс `G.` не добавляется, чтобы избежать «G.G» в некоторых ридерах.
- Обратная ↩︎ ведёт обратно в конкретную главу: `<chapter>.xhtml#ref-G`.

## Удаление дублей

- В тексте сноски могут встречаться лидирующие числа из источника (`16. ...`, `(١٦) ...`).
- Перед записью в `endnotes.xhtml` такие лидирующие числовые токены удаляются (арабские/персидские/латинские цифры + распространённая пунктуация).

## Надёжность

- Вся разметка строится как корректный XHTML: закрываются теги, соблюдается вложенность, используется объявление `xmlns:epub` там, где есть `epub:type`.
- Для Apple Books добавлен allowlist‑санитайзер, выбрасывающий ненадёжные обёртки `<span>`/`<a>` и их атрибуты.

