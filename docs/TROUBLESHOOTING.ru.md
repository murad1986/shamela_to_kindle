# Диагностика и решения

## Apple Books: “Namespace prefix epub … not defined”
- Причина: используется `epub:type`, но не объявлен `xmlns:epub`.
- Решение: в этом проекте фикс уже внедрён (корневой `<html>` содержит `xmlns:epub`).

## Apple Books: “Opening and ending tag mismatch: span … and p”
- Причина: разорванные/вложенные `<span>`/`<a>` из источника.
- Решение: очищаем контент от исходных `<span>`/`<a>`, закрываем теги в правильном порядке; включён allowlist‑санитайзер.
- Рекомендация: удалить старую книгу из Books перед повторным импортом (кэш).

## Kindle: e999 при загрузке
- Причины:
  - Встроенные шрифты, тяжёлые обложки, «страница обложки», сложные профили EPUB.
- Решение:
  - Используем минимальный профиль; без страницы обложки; по возможности JPEG; `nav.xhtml` есть в манифесте, но не в `spine`.
  - Если всё равно e999 — передать файл по USB напрямую.

## Обложка не добавляется
- Возможно, не прошли фильтры (MIME/размер/байты) или сеть недоступна.
- Попробуйте `--cover <file>`; при PNG/HEIC добавьте `--cover-convert-jpeg`.

## Ограничения сети / таймауты
- Увеличьте `--throttle` и уменьшите `--workers`.
- Повторите запуск; есть ретраи и вежливый лимитер с джиттером.

## Неправильная нумерация сносок
- В тексте — всегда глобальная нумерация `1..N` для консистентности и кликабельности.
- В конце — `<ol>`; явный префикс номера не добавляется, чтобы избежать «G.G».

