# Совместимость с Apple Books

Apple Books строго валидирует XHTML как XML и чувствителен к пространствам имён и вложенности тегов.

## Требования и решения

- Пространство имён EPUB:
  - Везде, где используется `epub:type`, корневой `<html>` должен объявлять
    `xmlns:epub="http://www.idpf.org/2007/ops"`.
  - Применено к главам, `nav.xhtml` и `endnotes.xhtml`.

- Жёсткая валидность XML:
  - Источник содержит служебные `<span>`/`<a>` (кнопки/якоря), которые ломают вложенность.
  - Мы удаляем все исходные `<span>` и `<a>`, оставляя допустимые теги: `p, br, strong, em, b, i, h1..h6, blockquote, ul, ol, li, sup, sub, table, thead, tbody, tr, th, td, pre, code, figure, figcaption, img, hr`.
  - Контент‑парсер закрывает теги в корректном порядке; перед записью включается профилируемый санитайзер (для Apple — более строгий).

- Сноски:
  - В тексте: глобальные `G` со ссылками на `endnotes.xhtml#note-G`.
  - В конце: `<ol>` формирует номер; явный префикс не добавляется, чтобы избежать «G.G».
  - ↩︎ возвращает к месту в главе.

## Проверка

- Внутренняя проверка: каждый XHTML‑файл главы парсится через XML‑парсер (well‑formed check) — ошибки вложенности исключаются.
- На устройстве: перед повторным импортом книги удалите старую копию (Books кэширует содержимое).

## Известные ограничения

- `epub:type` сохраняется, но полиформная семантика не критична — для Apple Books важней корректный XML.
- Если источник добавит новые классы/обёртки, возможно, придётся расширить allowlist‑санитайзер.
